<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium Globe - Robot Control</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.124/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.124/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        #loadingOverlay h1 {
            color: #4fc3f7;
            font-family: sans-serif;
        }
        
        /* Invisible overlay that appears when Ctrl is held */
        #selectOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            cursor: crosshair;
            display: none;
        }
        
        #selectionBox {
            position: absolute;
            border: 2px solid #4fc3f7;
            background: rgba(79, 195, 247, 0.2);
            pointer-events: none;
            z-index: 101;
            display: none;
        }
        
        #infoPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
            max-width: 320px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #infoPanel h3 { margin: 0 0 10px 0; color: #4fc3f7; }
        #clickCoords { margin-top: 10px; padding-top: 10px; border-top: 1px solid #444; }
        #robotStatus { margin-top: 10px; padding: 10px; background: rgba(76, 175, 80, 0.2); border-radius: 4px; border-left: 3px solid #4caf50; }
        .coord-label { color: #aaa; font-size: 12px; }
        .coord-value { color: #4fc3f7; font-family: monospace; font-size: 13px; }
        #distanceInfo { margin-top: 8px; padding-top: 8px; border-top: 1px solid #444; color: #ffd54f; }
        #selectedInfo { margin-top: 8px; padding-top: 8px; border-top: 1px solid #444; color: #4fc3f7; }
        
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            padding: 12px 15px;
            border-radius: 8px;
            color: #aaa;
            font-size: 12px;
            font-family: sans-serif;
            z-index: 1000;
        }
        #controls h4 { margin: 0 0 8px 0; color: #4fc3f7; font-size: 13px; }
        #controls div { margin: 4px 0; }
        #controls span { color: #fff; }
        
        #unitInfoBox {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #00bcd4;
            z-index: 1000;
            font-size: 13px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-width: 200px;
            display: none;
        }
        #unitInfoBox h4 { margin: 0 0 10px 0; color: #00bcd4; font-size: 15px; }
        #unitInfoBox .info-row { display: flex; justify-content: space-between; margin: 6px 0; }
        #unitInfoBox .info-label { color: #888; }
        #unitInfoBox .info-value { color: #fff; font-family: monospace; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="selectOverlay"></div>
    <div id="selectionBox"></div>
    <div id="loadingOverlay"><h1>Loading 3D Tiles...</h1></div>
    
    <div id="infoPanel">
        <h3>ðŸ¤– Robot Control</h3>
        <div id="clickCoords">
            <div class="coord-label">Target position:</div>
            <div class="coord-value" id="latValue">â€”</div>
            <div class="coord-value" id="lonValue">â€”</div>
            <div class="coord-value" id="altValue">â€”</div>
        </div>
        <div id="robotStatus">
            <div class="coord-label">Robot Alpha:</div>
            <div class="coord-value" id="robotPos">34.0522Â° N, 118.2437Â° W</div>
            <div class="coord-value" id="robotAlt">Alt: 0m</div>
        </div>
        <div id="distanceInfo">
            <div class="coord-label">Distance to target:</div>
            <div class="coord-value" id="distanceValue">â€”</div>
            <div class="coord-value" id="bearingValue">â€”</div>
        </div>
        <div id="selectedInfo">
            <div class="coord-label">Selected units:</div>
            <div class="coord-value" id="selectedUnits">None</div>
        </div>
    </div>
    
    <div id="controls">
        <h4>Controls</h4>
        <div><span>Left-drag</span> â€” Rotate</div>
        <div><span>Ctrl+Left-drag</span> â€” Select units</div>
        <div><span>Middle-drag</span> â€” Orbit</div>
        <div><span>Scroll</span> â€” Zoom</div>
        <div style="margin-top: 10px; color: #4fc3f7;"><span>Right-click</span> â€” Set waypoint</div>
    </div>
    
    <div id="unitInfoBox">
        <h4 id="unitName">Robot Alpha</h4>
        <div class="info-row">
            <span class="info-label">Status</span>
            <span class="info-value" id="unitStatus">Idle</span>
        </div>
        <div class="info-row">
            <span class="info-label">Battery</span>
            <span class="info-value" id="unitBattery">87%</span>
        </div>
        <div class="info-row">
            <span class="info-label">Speed</span>
            <span class="info-value" id="unitSpeed">0 m/s</span>
        </div>
        <div class="info-row">
            <span class="info-label">Position</span>
            <span class="info-value" id="unitPosition">â€”</span>
        </div>
        <div class="info-row">
            <span class="info-label">Altitude</span>
            <span class="info-value" id="unitAltitude">â€”</span>
        </div>
    </div>

    <script type="module">
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhY2QwYzljZC01YWNmLTQwNTEtOTYwYi0zODJmYTFhYmJlMDYiLCJpZCI6Mzc2NTAxLCJpYXQiOjE3Njc5MTcyMzd9.XjmYQSp3HkH1ZsrbnAlq7dL_P_43K6o7JXHPO9rpcvw';

        const ROBOT_START = { lon: -118.2437, lat: 34.0522, alt: 0 };

        const viewer = new Cesium.Viewer('cesiumContainer', {
            globe: false,
            skyAtmosphere: new Cesium.SkyAtmosphere(),
            sceneModePicker: false,
            baseLayerPicker: false,
            geocoder: Cesium.IonGeocodeProviderType.GOOGLE,
            animation: false,
            timeline: false,
            navigationHelpButton: false,
            fullscreenButton: true,
            homeButton: false,
            infoBox: false,
            selectionIndicator: false
        });

        const controller = viewer.scene.screenSpaceCameraController;
        controller.rotateEventTypes = [Cesium.CameraEventType.LEFT_DRAG];
        controller.tiltEventTypes = [Cesium.CameraEventType.MIDDLE_DRAG];
        controller.zoomEventTypes = [Cesium.CameraEventType.WHEEL];
        controller.lookEventTypes = [];
        controller.translateEventTypes = [];
        controller.inertiaSpin = 0;
        controller.inertiaTranslate = 0;
        controller.inertiaZoom = 0;

        // Elements
        const selectOverlay = document.getElementById('selectOverlay');
        const selectionBox = document.getElementById('selectionBox');
        const unitInfoBox = document.getElementById('unitInfoBox');

        try {
            const tileset = await Cesium.Cesium3DTileset.fromIonAssetId(2275207);
            viewer.scene.primitives.add(tileset);
            document.getElementById('loadingOverlay').style.display = 'none';
            
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(ROBOT_START.lon, ROBOT_START.lat, 500),
                orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 },
                duration: 3
            });

            // Robot marker
            const robot = viewer.entities.add({
                name: 'Robot Alpha',
                position: Cesium.Cartesian3.fromDegrees(ROBOT_START.lon, ROBOT_START.lat, ROBOT_START.alt + 2),
                point: {
                    pixelSize: 16,
                    color: Cesium.Color.LIME,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 3,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                },
                label: {
                    text: 'ðŸ¤– Robot Alpha',
                    font: 'bold 14px sans-serif',
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    outlineWidth: 2,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset: new Cesium.Cartesian2(0, -28),
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                },
                properties: { type: 'robot', battery: 87, status: 'Idle', speed: 0 }
            });
            
            // Selection ring
            const selectionRing = viewer.entities.add({
                position: new Cesium.CallbackProperty(() => robot.position.getValue(viewer.clock.currentTime), false),
                point: {
                    pixelSize: 28,
                    color: Cesium.Color.TRANSPARENT,
                    outlineColor: Cesium.Color.CYAN,
                    outlineWidth: 3,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                },
                show: false
            });

            const units = [{ entity: robot, ring: selectionRing, waypoint: null, pathLine: null }];
            let selectedUnits = [];

            // Helpers
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000;
                const Ï†1 = lat1 * Math.PI / 180, Ï†2 = lat2 * Math.PI / 180;
                const Î”Ï† = (lat2 - lat1) * Math.PI / 180, Î”Î» = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2)**2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }

            function calculateBearing(lat1, lon1, lat2, lon2) {
                const Ï†1 = lat1 * Math.PI / 180, Ï†2 = lat2 * Math.PI / 180;
                const Î”Î» = (lon2 - lon1) * Math.PI / 180;
                const y = Math.sin(Î”Î») * Math.cos(Ï†2);
                const x = Math.cos(Ï†1) * Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
                return ((Math.atan2(y, x) * 180 / Math.PI) + 360) % 360;
            }

            function selectUnit(unitObj) {
                if (!selectedUnits.includes(unitObj)) selectedUnits.push(unitObj);
                unitObj.ring.show = true;
                
                // Show waypoint and path if they exist
                if (unitObj.waypoint) unitObj.waypoint.show = true;
                if (unitObj.pathLine) unitObj.pathLine.show = true;
                
                const props = unitObj.entity.properties;
                const pos = unitObj.entity.position.getValue(viewer.clock.currentTime);
                const carto = Cesium.Cartographic.fromCartesian(pos);
                
                document.getElementById('unitName').textContent = unitObj.entity.name;
                document.getElementById('unitStatus').textContent = props.status.getValue();
                document.getElementById('unitBattery').textContent = props.battery.getValue() + '%';
                document.getElementById('unitSpeed').textContent = props.speed.getValue() + ' m/s';
                document.getElementById('unitPosition').textContent = 
                    Cesium.Math.toDegrees(carto.latitude).toFixed(4) + 'Â°, ' +
                    Cesium.Math.toDegrees(carto.longitude).toFixed(4) + 'Â°';
                document.getElementById('unitAltitude').textContent = carto.height.toFixed(1) + ' m';
                unitInfoBox.style.display = 'block';
                document.getElementById('selectedUnits').textContent = unitObj.entity.name;
            }
            
            function deselectAll() {
                selectedUnits.forEach(u => {
                    u.ring.show = false;
                    // Hide waypoint and path but don't delete them
                    if (u.waypoint) u.waypoint.show = false;
                    if (u.pathLine) u.pathLine.show = false;
                });
                selectedUnits = [];
                unitInfoBox.style.display = 'none';
                document.getElementById('selectedUnits').textContent = 'None';
            }

            const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            
            // Right-click: set waypoint (only if a unit is selected)
            handler.setInputAction(function(click) {
                // Only allow waypoint if we have a selected unit
                if (selectedUnits.length === 0) {
                    console.log('No unit selected - cannot set waypoint');
                    return;
                }
                
                const cartesian = viewer.scene.pickPosition(click.position);
                if (!Cesium.defined(cartesian)) return;
                
                const carto = Cesium.Cartographic.fromCartesian(cartesian);
                const lat = Cesium.Math.toDegrees(carto.latitude);
                const lon = Cesium.Math.toDegrees(carto.longitude);
                const alt = carto.height;
                
                document.getElementById('latValue').textContent = `Lat: ${lat.toFixed(6)}Â°`;
                document.getElementById('lonValue').textContent = `Lon: ${lon.toFixed(6)}Â°`;
                document.getElementById('altValue').textContent = `Alt: ${alt.toFixed(1)}m`;
                
                const dist = calculateDistance(ROBOT_START.lat, ROBOT_START.lon, lat, lon);
                const bear = calculateBearing(ROBOT_START.lat, ROBOT_START.lon, lat, lon);
                document.getElementById('distanceValue').textContent = dist < 1000 ? `${dist.toFixed(1)} m` : `${(dist/1000).toFixed(2)} km`;
                document.getElementById('bearingValue').textContent = `Bearing: ${bear.toFixed(1)}Â°`;
                
                // Set waypoint for each selected unit
                selectedUnits.forEach(unitObj => {
                    // Remove old waypoint and path if they exist
                    if (unitObj.waypoint) viewer.entities.remove(unitObj.waypoint);
                    if (unitObj.pathLine) viewer.entities.remove(unitObj.pathLine);
                    
                    // Get unit's current position for the path line
                    const unitPos = unitObj.entity.position.getValue(viewer.clock.currentTime);
                    const unitCarto = Cesium.Cartographic.fromCartesian(unitPos);
                    const unitLon = Cesium.Math.toDegrees(unitCarto.longitude);
                    const unitLat = Cesium.Math.toDegrees(unitCarto.latitude);
                    const unitAlt = unitCarto.height;
                    
                    unitObj.waypoint = viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(lon, lat, alt + 2),
                        point: { pixelSize: 14, color: Cesium.Color.RED, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, disableDepthTestDistance: Number.POSITIVE_INFINITY },
                        label: { text: 'Target', font: '12px sans-serif', style: Cesium.LabelStyle.FILL_AND_OUTLINE, outlineWidth: 2, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -18), disableDepthTestDistance: Number.POSITIVE_INFINITY }
                    });
                    
                    unitObj.pathLine = viewer.entities.add({
                        polyline: {
                            positions: [Cesium.Cartesian3.fromDegrees(unitLon, unitLat, unitAlt + 2), Cesium.Cartesian3.fromDegrees(lon, lat, alt + 2)],
                            width: 4,
                            material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.YELLOW, dashLength: 16 })
                        }
                    });
                });
                
                console.log('Navigate to:', { lat, lon, alt, distance: dist, bearing: bear });
            }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
            
            // Left-click: select unit or deselect
            handler.setInputAction(function(click) {
                const picked = viewer.scene.pick(click.position);
                if (Cesium.defined(picked) && picked.id) {
                    const unit = units.find(u => u.entity === picked.id);
                    if (unit) {
                        deselectAll();
                        selectUnit(unit);
                        return;
                    }
                }
                deselectAll();
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            // ==========================================
            // CTRL KEY SHOWS OVERLAY FOR BOX SELECTION
            // ==========================================
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Control') {
                    selectOverlay.style.display = 'block';
                }
            });
            
            document.addEventListener('keyup', (e) => {
                if (e.key === 'Control') {
                    selectOverlay.style.display = 'none';
                    selectionBox.style.display = 'none';
                }
            });

            // ==========================================
            // BOX SELECTION ON THE OVERLAY
            // ==========================================
            let isDragging = false;
            let startX = 0, startY = 0;
            
            selectOverlay.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left click only
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    selectionBox.style.left = startX + 'px';
                    selectionBox.style.top = startY + 'px';
                    selectionBox.style.width = '0px';
                    selectionBox.style.height = '0px';
                    selectionBox.style.display = 'block';
                    e.preventDefault();
                }
            });
            
            selectOverlay.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const currentX = e.clientX;
                const currentY = e.clientY;
                
                const left = Math.min(startX, currentX);
                const top = Math.min(startY, currentY);
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);
                
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
            });
            
            selectOverlay.addEventListener('mouseup', (e) => {
                if (!isDragging) return;
                isDragging = false;
                
                const endX = e.clientX;
                const endY = e.clientY;
                
                // Hide selection box
                selectionBox.style.display = 'none';
                
                // Calculate screen bounds
                const minScreenX = Math.min(startX, endX);
                const maxScreenX = Math.max(startX, endX);
                const minScreenY = Math.min(startY, endY);
                const maxScreenY = Math.max(startY, endY);
                
                console.log('Selection box bounds:', { minScreenX, maxScreenX, minScreenY, maxScreenY });
                
                // Need minimum drag distance
                if (maxScreenX - minScreenX < 5 && maxScreenY - minScreenY < 5) return;
                
                deselectAll();
                
                // Check each unit's screen position
                units.forEach(unitObj => {
                    const worldPos = unitObj.entity.position.getValue(viewer.clock.currentTime);
                    console.log('World position:', worldPos);
                    
                    const screenPos = Cesium.SceneTransforms.worldToWindowCoordinates(viewer.scene, worldPos);
                    console.log('Screen position:', screenPos);
                    
                    if (screenPos) {
                        console.log('Checking if robot at (' + screenPos.x + ', ' + screenPos.y + ') is inside box');
                        
                        // Check if robot's screen position is inside the selection box
                        if (screenPos.x >= minScreenX && screenPos.x <= maxScreenX &&
                            screenPos.y >= minScreenY && screenPos.y <= maxScreenY) {
                            selectUnit(unitObj);
                            console.log('SELECTED:', unitObj.entity.name);
                        } else {
                            console.log('Robot outside box');
                        }
                    } else {
                        console.log('screenPos is undefined - robot may be off screen or behind camera');
                    }
                });
            });
            
            // Handle mouse leaving the overlay while dragging
            selectOverlay.addEventListener('mouseleave', (e) => {
                if (isDragging) {
                    isDragging = false;
                    selectionBox.style.display = 'none';
                }
            });

            console.log('Ready! Hold Ctrl and drag to box-select units.');
            
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loadingOverlay').innerHTML = '<h1 style="color:red;">Error: ' + error.message + '</h1>';
        }
    </script>
</body>
</html>
